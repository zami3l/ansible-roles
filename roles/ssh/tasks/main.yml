---

- name: Create new groups
  group:
    name: "{{ item.name }}"
    state: present
  loop: "{{ GROUPS }}"

- name: Create new users
  user:
    name: "{{ item.name }}"
    groups: "{{ item.group }}"
    state: present
  loop: "{{ USERS }}"

- name: Create /etc/ssh/authorized_keys/ folder
  file:
    path: /etc/ssh/authorized_keys
    state: directory
    mode: 0755

- name: Add ssh keys users in /etc/ssh/authorized_keys/
  copy:
    src: "{{ item.path_ssh_keys }}"
    dest: "/etc/ssh/authorized_keys/{{ item.name }}"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0600
  loop: "{{ PUBKEY }}"

- name: Configuration ssh
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    regexp: "^(#* *%*)?{{ item.name }}"
    line: "{{ item.name }} {{ item.value }}"
  loop:
    - { name: Port, value: "{{ PORT_SSH }}" }
    - { name: PermitRootLogin, value: "no" }
    - { name: PubkeyAuthentication, value: "yes" }
    - { name: AuthorizedKeysFile, value: "/etc/ssh/authorized_keys/%u" }
    - { name: PasswordAuthentication, value: "yes" }
    - { name: KerberosAuthentication, value: "no" }
    - { name: GSSAPIAuthentication, value: "no" }
  notify:
    - restart_sshd

- name: Allow wheel group to use sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    create: yes
    regexp: '^(#* *%*)?wheel'
    line: '%wheel ALL=(ALL) ALL'
  when: ansible_distribution != 'OpenBSD'

- name: Allow wheel group to use doas
  lineinfile:
    dest: /etc/doas.conf
    state: present
    create: yes
    regexp: '^(#* *%*)?permit: wheel'
    line: 'permit :wheel'
  when: ansible_distribution == 'OpenBSD'
